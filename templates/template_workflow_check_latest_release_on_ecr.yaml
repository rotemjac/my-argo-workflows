apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: check-latest-release-on-ecr-template
spec:
  entrypoint: main
  arguments:
    parameters:
      - name: ecr_name
        value: "WorkflowTemplate default value"
      - name: worker_nodes_role_name
        value: "WorkflowTemplate default value"
      - name: region
        value: "WorkflowTemplate default value"
  templates:
    - name: main
      steps:
        - - name: get-creds
            template: get-creds
        #- - name: build
        #    template: build
        #- - name: test
        #    template: test
    - name: get-creds
      container:
        image: amazon/aws-cli
        workingDir: /app
        command:
          - /bin/sh
          - -c
          - |-
            export AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query "Account" --output text)

            unset AWS_ACCESS_KEY_ID
            export AWS_ACCESS_KEY_ID=$(aws sts assume-role --role-arn arn:aws:iam::${AWS_ACCOUNT_ID}:role/{{workflow.parameters.worker_nodes_role_name}} --role-session-name RoleSession --query 'Credentials.AccessKeyId')

            unset AWS_SECRET_ACCESS_KEY
            export AWS_SECRET_ACCESS_KEY=$(aws sts assume-role --role-arn arn:aws:iam::${AWS_ACCOUNT_ID}:role/{{workflow.parameters.worker_nodes_role_name}} --role-session-name RoleSession --query 'Credentials.SecretAccessKey')

            unset AWS_SESSION_TOKEN
            export AWS_SESSION_TOKEN=$(aws sts assume-role --role-arn arn:aws:iam::${AWS_ACCOUNT_ID}:role/{{workflow.parameters.worker_nodes_role_name}} --role-session-name RoleSession --query 'Credentials.SessionToken')

            export AWS_DEFAULT_REGION="{{workflow.parameters.region}}"

            echo $(aws ecr list-images --repository-name "{{workflow.parameters.ecr_name}}")

            sleep 100000
        #command: [cowsay]
        #args: ["{{inputs.parameters.msg}}"]